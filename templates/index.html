<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Ouvrir la cam√©ra</title>
    <style>
        video, img {
            width: 100%;
            max-width: 400px;
            border: 2px solid #444;
            border-radius: 10px;
        }
        #warning {
            color: red;
            font-weight: bold;
        }
        #preview-section {
            margin-top: 1rem;
            display: none; /* cach√© tant qu‚Äôaucune photo n‚Äôest prise */
        }
        button {
            padding: 0.4rem 0.8rem;
            margin: 0.25rem;
        }
    </style>
</head>
<body>

<h2>Acc√®s √† la cam√©ra</h2>

<p id="warning"></p>

<button id="btnOpenCam">Ouvrir la cam√©ra</button>
<button id="btnCapture" disabled>Prendre une photo</button>
<br><br>
<video id="video" autoplay playsinline></video>

<!-- Pr√©visualisation + boutons Valider / Annuler -->
<div id="preview-section">
    <h3>Pr√©visualisation</h3>
    <canvas id="canvas" style="display:none;"></canvas>
    <img id="preview" alt="Pr√©visualisation de la photo">
    <br>
    <button id="btnValidate">Valider</button>
    <button id="btnCancel">Annuler</button>
</div>

<script>
    // D√©tection mobile
    const isMobile = /Android|iPhone|iPad|iPod|webOS|BlackBerry|Windows Phone/i.test(navigator.userAgent);
    const btnOpenCam = document.getElementById("btnOpenCam");
    const btnCapture = document.getElementById("btnCapture");
    const warning = document.getElementById("warning");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const previewSection = document.getElementById("preview-section");
    const preview = document.getElementById("preview");
    const btnValidate = document.getElementById("btnValidate");
    const btnCancel = document.getElementById("btnCancel");

    let stream = null;
    let capturedDataUrl = null; // contiendra la photo captur√©e (base64)

    if (!isMobile) {
        btnOpenCam.disabled = true;
        btnCapture.disabled = true;
        btnOpenCam.style.opacity = "0.5";
        btnCapture.style.opacity = "0.5";
        warning.innerText = "Fonction disponible uniquement sur mobile.";
    }

    // Ouvrir la cam√©ra
    btnOpenCam.addEventListener("click", function () {
        if (!isMobile) return;

        const constraints = {
            audio: false,
            video: {
                facingMode: "environment"  // arri√®re
            }
        };

        navigator.mediaDevices.getUserMedia(constraints)
            .then(function(s) {
                stream = s;
                video.srcObject = stream;
                btnCapture.disabled = false; // on peut maintenant prendre une photo
            })
            .catch(function(err) {
                alert("Erreur : " + err);
            });
    });

    // Prendre une photo
    btnCapture.addEventListener("click", function () {
        if (!stream) return;

        // taille du canvas = taille de la vid√©o
        const width = video.videoWidth || 400;
        const height = video.videoHeight || 300;

        canvas.width = width;
        canvas.height = height;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, width, height);

        // On r√©cup√®re l'image en base64
        capturedDataUrl = canvas.toDataURL("image/jpeg", 0.9);

        // On affiche l‚Äôaper√ßu
        preview.src = capturedDataUrl;
        previewSection.style.display = "block";
    });

    // Valider la photo
    // btnValidate.addEventListener("click", function () {
    //     if (!capturedDataUrl) return;

    //     // Ici tu pourras envoyer `capturedDataUrl` au backend Flask via fetch()

    //     console.log("Photo valid√©e !");
    //     console.log(capturedDataUrl);

        // try {
        //         const response = await fetch("/analyze", {
        //             method: "POST",
        //         headers: {
        //         "Content-Type": "application/json"
        //             },
        //         body: JSON.stringify({
        //         image: capturedDataUrl   // on envoie la dataURL au backend
        //         })
        //     });

        //     if (!response.ok) {
        //         console.error("Erreur lors de l'upload :", response.statusText);
        //     return;
        //     }
        //     const result = await response.json();
        //     console.log("Upload r√©ussi :", result);
        // // ici tu peux afficher un message √† l'utilisateur, etc.

        //     } catch (error) {
        //     console.error("Erreur r√©seau ou serveur :", error);
        // }

    //     alert("Photo valid√©e");

    //     // Optionnel : arr√™ter la cam√©ra apr√®s validation
    //     if (stream) {
    //         stream.getTracks().forEach(t => t.stop());
    //         stream = null;
    //     }
    // });
//     btnValidate.addEventListener("click", async function () {
//     if (!capturedDataUrl) return;

//     console.log("Photo valid√©e !");
//     console.log(capturedDataUrl);

//     try {
//         const response = await fetch("/analyze", {
//             method: "POST",
//             headers: {
//                 "Content-Type": "application/json"
//             },
//             body: JSON.stringify({
//                 image: capturedDataUrl   // üîπ on envoie la dataURL au backend
//             })
//         });

//         const result = await response.json();

//         if (!response.ok) {
//             console.error("Erreur lors de l'analyse :", result);
//             alert(result.error || result.erreur || "Erreur lors de l'analyse de l'image");
//             return;
//         }

//         console.log("R√©sultat analyse :", result);
//         // ici tu peux afficher les ingr√©dients sur la page, par ex. :
//         // alert("Ingr√©dients d√©tect√©s : " + result.ingredients_detectes.join(", "));

//     } catch (err) {
//         console.error("Erreur r√©seau ou serveur :", err);
//         alert("Erreur r√©seau ou serveur");
//     }
// });

//     // Annuler la photo (recommencer)
//     btnCancel.addEventListener("click", function () {
//         capturedDataUrl = null;
//         preview.src = "";
//         previewSection.style.display = "none";
//         // la cam√©ra reste active, l‚Äôutilisateur peut reprendre une photo
//     });
// btnValidate.addEventListener("click", async function () {
//     if (!capturedDataUrl) return;

//     console.log("Photo valid√©e !");
//     console.log("Taille dataURL :", capturedDataUrl.length);

//     try {
//         const response = await fetch("/analyze", {
//             method: "POST",
//             headers: {
//                 "Content-Type": "application/json"
//             },
//             body: JSON.stringify({
//                 image: capturedDataUrl   // on envoie la dataURL au backend
//             })
//         });

//         const result = await response.json().catch(() => null);
//         console.log("Status HTTP :", response.status);
//         console.log("R√©ponse backend :", result);

//         if (!response.ok) {
//             alert(
//                 (result && (result.error || result.erreur || result.message)) ||
//                 "Erreur c√¥t√© serveur (" + response.status + ")"
//             );
//             return;
//         }

//         alert("Analyse OK, ingr√©dients d√©tect√©s : " + result.ingredients_detectes.join(", "));

//     } catch (error) {
//         console.error("Erreur r√©seau ou serveur :", error);
//         alert("Erreur r√©seau ou serveur");
//     }

//     // Optionnel : arr√™ter la cam√©ra apr√®s validation
//     if (stream) {
//         stream.getTracks().forEach(t => t.stop());
//         stream = null;
//     }
//   });
// Valider la photo
btnValidate.addEventListener("click", async function () {
    if (!capturedDataUrl) return;

    console.log("Photo valid√©e !");
    console.log("Taille dataURL :", capturedDataUrl.length);

    try {
        const response = await fetch("/analyze", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                // üîπ exactement ce que ton backend attend :
                image: capturedDataUrl
            })
        });
        console.log("Status HTTP :", response.status);

        // On lit la r√©ponse brute (texte) pour d√©bug
        const raw = await response.text();
        console.log("R√©ponse brute du backend :", raw);

        let result = null;
        try {
            result = JSON.parse(raw);
        } catch (e) {
            console.warn("Impossible de parser le JSON :", e);
        }

        // Si le serveur a renvoy√© une erreur (400, 500‚Ä¶)
        if (!response.ok) {
            const msgErreur =
                (result && (result.error || result.erreur || result.message)) ||
                "Erreur c√¥t√© serveur (" + response.status + ")";
            alert(msgErreur);
            return; // surtout ne pas toucher √† result.ingredients_detectes
        }

        // Ici on est en "succ√®s" HTTP.
        // On v√©rifie que la propri√©t√© existe AVANT de l'utiliser.
        if (!result || !Array.isArray(result.ingredients_detectes)) {
            console.error("R√©ponse inattendue (pas d'ingredients_detectes) :", result);
            alert("R√©ponse inattendue du serveur (pas d'ingredients_detectes). Regarde la console.");
            return;
        }

        console.log("Ingr√©dients d√©tect√©s :", result.ingredients_detectes);
        alert("Ingr√©dients d√©tect√©s : " + result.ingredients_detectes.join(", "));

    } catch (error) {
        console.error("Erreur r√©seau ou serveur :", error);
        alert("Erreur r√©seau ou serveur. Regarde la console.");
    }

    // Optionnel : arr√™ter la cam√©ra apr√®s validation
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }
});

</script>

</body>
</html>
